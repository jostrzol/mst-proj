---
title: "Survey analysis"
format:
  html:
    code-fold: true
jupyter: python3
---

```{python}
# | echo: false

# pyright: reportUnusedCallResult=false
# pyright: reportUnknownVariableType=false

from collections.abc import Iterable
import matplotlib.pyplot as plt
from matplotlib.ticker import PercentFormatter
import pandas as pd
import numpy as np


from enum import Enum, auto
from pathlib import Path
from typing import Any, Callable, override
from matplotlib.axes import Axes
from IPython.display import display


plt.rcParams["figure.figsize"] = [6.4, 4.8]


def find_root_dir():
    start_path = Path(__file__).parent if "__file__" in globals() else Path.cwd()
    current = start_path
    while current != current.parent:
        if (current / ".git").exists():
            return current
        current = current.parent
    return start_path


ROOT_DIR = find_root_dir()
SURVEY_PATH = ROOT_DIR / "./analysis-src/survey.csv"


class Column(Enum):
    "Columns in the survey dataframe"

    TIMESTAMP = auto()
    "Timestamp"

    # Section 1: Demographics and role
    S1_INDUSTRY = auto()
    "Industry segment"
    S1_ROLE = auto()
    "Your primary role"

    # Section 2: Current language usage
    S2_LANGUAGES_USED = auto()
    """Which programming languages do you currently use or have used in the past
    for microcontroller projects?"""
    S2_C_CPP_RATIO = auto()
    "What ratio of your embedded codebase is in C/C++?"

    # Section 3: Pain points and challenges
    S3_PERFORMANCE = auto()
    "Real‑time performance"
    S3_DEBUGGING = auto()
    "Debugging microcontroller programs"
    S3_LEGACY = auto()
    "Integration with legacy code"
    S3_HARDWARE = auto()
    "Interacting with hardware"
    S3_MEMORY = auto()
    "Memory constraints (binary size, RAM/flash usage)"
    S3_MEMORY_SAFETY = auto()
    "Memory vulnerabilities (e.g. use after free, buffer overflows)"
    S3_POWER = auto()
    "Power consumption management"
    S3_CERTIFICATION = auto()
    "Safety certification (e.g. IEC 61508, ISO 26262)"
    S3_TOOLING = auto()
    "Tooling complexity (e.g. build system)"

    # Section 4: Language selection criteria
    S4_LIBRARIES = auto()
    "Availability of libraries"
    S4_C_INTEROPERABILITY = auto()
    "Interoperability with C code"
    S4_MATURITY = auto()
    "Maturity of compiler/toolchain"
    S4_PERFORMANCE = auto()
    "Real-time performance"
    S4_MEMORY_SAFETY = auto()
    "Safety of memory management"
    S4_COMMUNITY = auto()
    "Strong community support"
    S4_TRAINING = auto()
    "Team expertise and training cost"
    S4_TOOLING = auto()
    "Tooling features and usability (e.g. build system)"

    # Section 5: Modern language adoption
    S5_DID_USE_MODERN = auto()
    "Have you ever used any “modern” language (e.g. Rust, Zig) for embedded development?"
    S5_BARRIERS = auto()
    "If not, what barriers prevent you?"
    S5_MODERN_ADOPTION = auto()
    "How likely are you to adopt any “modern” language in the next 12 months?"

    # Section 6: Tooling and ecosystem
    S6_BUILD_SYSTEM_SATISFACTION = auto()
    """Rate your satisfaction with the build system for C/C++ that you use for
    embedded projects."""
    S6_STATIC_ANALYSIS_RELIANCE = auto()
    """How much do you rely on C/C++ static analysis tools for microcontroller
    code? (e.g. clang-tidy, MISRA checkers)"""
    S6_STATIC_ANALYSIS_SATISFACTION = auto()
    """Rate your satisfaction with C/C++ static analysis tools for
    microcontroller code."""

    # Section 7: Open section
    S7_WANTED_FEATURES = auto()
    """Can you think of any language or tooling features would most help your
    embedded development?"""
    S7_COMMENTS = auto()
    "Any additional comments?"

    @override
    def __str__(self) -> str:
        return self.name
```

```{python}
df = pd.read_csv(SURVEY_PATH)
df.columns = [column for column in Column]
display(df.head())
```

```{python}
# | echo: false


def preprocess_multichoice(
    series: pd.Series,
    replace: dict[Any, Any | list[Any]] | None = None,
    drop: list[Any] | None = None,
) -> pd.Series:
    replace = replace or {}

    def replace_value(value: Any) -> list[Any]:
        replacement = replace.get(value, value)
        return replacement if isinstance(replacement, list) else [replacement]

    def preprocess_row(lst: list[Any]) -> list[Any]:
        series = pd.Series(lst)
        series = series.map(replace_value).explode()
        series = series[~series.isin(drop or [])]
        return series.to_list()

    return series.apply(preprocess_row)


def plot_hist(
    series: pd.Series,
    range: Iterable[Any] | None = None,
    rotated: bool = False,
    sort_by_index: bool = False,
    format: Callable[[Any], Any] | None = None,
):
    series = series.explode()  # in case multichoice
    values = series.value_counts()
    for label in range or []:
        if label not in values:
            values[label] = 0
    if sort_by_index:
        values = values.sort_index()
    if format:
        labels = values.index.map(format)
        values.index = labels

    ax = values.plot(kind="bar")

    if rotated:
        plt.setp(ax.get_xticklabels(), rotation=45, ha="right")
    else:
        plt.setp(ax.get_xticklabels(), rotation=0)

    for i, v in enumerate(values):
        ax.text(i, v + 0.1, str(v), ha="center", va="bottom")

    ax.set_ylim(top=max(values) * 1.07)
    ax.yaxis.set_major_formatter(PercentFormatter(decimals=0))
    return ax


def plot_pie(series: pd.Series):
    values = series.value_counts()
    total = values.sum()

    def fmt(percent: np.float64):
        count = (percent / 100 * total).astype(np.int64)
        return f"{count} ({percent:.0f}%)"

    values.plot(kind="pie", autopct=fmt)


ax: Axes
df_out = pd.DataFrame()
```

## Section 1: Demographics and role

### Industry segment

```{python}
column = Column.S1_INDUSTRY
values = df[column].str.split(";")


values = preprocess_multichoice(
    values,
    replace={
        "Material Handling (Forklifts)": "Automotive",
        "Transport": "Automotive",
        "Silicon photonics and lasers": "Silicon production",
        "Fabless semiconductor company": "Silicon production",
        "Computer networking": "Networks",
        "Telecoms": "Networks",
        "IMS": "Networks",
        "Wireless charging": "Consumer electronics",
        "Stage lighting equipment": "Professional electronics",
        "Professionnel Photography/Lighting": "Professional electronics",
        "test and measurements": "Professional electronics",
        "Metering": "Professional electronics",
        "Datacenter": "Professional electronics",
        "Hobby": "Consumer electronics",
        "Scientific Research Instrumentation": "Research",
    },
    drop=["Software Development", "Open Source"],
)
df_out[column] = values
plot_hist(values, rotated=True)
plt.show()
```

### Primary role

```{python}
column = Column.S1_ROLE
values = df[column]

values = preprocess_multichoice(
    values,
    replace={
        "Hardware and Software": ["Software engineer", "Hardware engineer"],
        "Both hard and software (firmware)": ["Software engineer", "Hardware engineer"],
        "HW / SW engineer": ["Software engineer", "Hardware engineer"],
        "all of the above": [
            "Software engineer",
            "Hardware engineer",
            "System architect",
        ],
    },
)
df_out[column] = values
plot_hist(values)
plt.show()
```

## Section 2: Current language use

### Language use

```{python}
column = Column.S2_LANGUAGES_USED
values = df[column].str.split(";")

values = preprocess_multichoice(
    values,
    replace={
        "JavaScript / TypeScript (e.g. Espruino)": "JavaScript/TypeScript",
        "Assembler": "Assembly",
        "Bash": "Shell scripts",
        "scheme, forth, Dylan": ["Scheme", "Forth", "Dylan"],
    },
)
df_out[column] = values
plot_hist(values, rotated=True)
plt.show()
```

### C/C++ vs other languages

```{python}
column = Column.S2_C_CPP_RATIO
values = df[column]
df_out[column] = values

plot_hist(
    values,
    rotated=True,
    sort_by_index=True,
    format=lambda x: f"{x*10} %",
    range=range(11),
)
plt.show()
```

## Section 3: Pain points and challenges

```{python}
# | layout-ncol: 3

columns = [
    Column.S3_PERFORMANCE,
    Column.S3_DEBUGGING,
    Column.S3_LEGACY,
    Column.S3_HARDWARE,
    Column.S3_MEMORY,
    Column.S3_MEMORY_SAFETY,
    Column.S3_POWER,
    Column.S3_CERTIFICATION,
    Column.S3_TOOLING,
]

for column in columns:
    values = df[column]
    df_out[column] = values

    plot_hist(values, sort_by_index=True, range=range(1, 6))
    plt.show()
```

## Section 4: Language selection criteria

```{python}
# | layout-ncol: 3

columns = [
    Column.S4_LIBRARIES,
    Column.S4_C_INTEROPERABILITY,
    Column.S4_MATURITY,
    Column.S4_PERFORMANCE,
    Column.S4_MEMORY_SAFETY,
    Column.S4_COMMUNITY,
    Column.S4_TRAINING,
    Column.S4_TOOLING,
]

for column in columns:
    values = df[column]
    df_out[column] = values

    plot_hist(values, sort_by_index=True, range=range(1, 6))
    plt.show()
```

## Section 5: Modern language adoption

### Modern language use

```{python}
column = Column.S5_DID_USE_MODERN
values = df[column]
df_out[column] = values

plot_pie(values)
plt.show()
```

### Barriers

```{python}
column = Column.S5_BARRIERS
values = df[column].str.split(";")

print(values.explode().unique().tolist())

values = preprocess_multichoice(
    values,
    replace={
        "No need for such language in the workflow": "No need",
        "no need to": "No need",
        "Don't see the need for any of these languages. C can do all I need.": "No need",
        "Satisfied with existing tools no nee to look elsewhere": "No need",
        "No significant benefits": "No need",
        "C works": "No need",
        "Irrelevance": "No need",
        "doesn't seem worth the effort for most of our needs": "Not worth trying",
        "Makes no sense to waste time in something which is 99% likely unnecessary hype, does not solve actual problems, solves non-problems, and introduces new problems, only to be forgotten in 1-2 more years like happened to Rust already": "Not worth trying",
        "Lack of time - it is faster for me to write in C, especially when there is many projects in a backlog": "Not worth trying",
        "I want my code to build and work the same after 30 years.": "Lack of mature toolchain",
        "Resourse constraints": "Insufficient performance",
        "code size, compilation time (Rust), obstacles to breaking abstraction layers, lack of code portability across 8/16/32/64 bit and older or non-mainstream ISAs, coding speed": [
            "Insufficient performance",
            "Insufficient producivity",
            "Insufficient portability",
        ],
        "lightness of C": "Insufficient performance",
        "Fear of insufficient performance": "Insufficient performance",
        "Difficulty of integrating into existing codebase": "Difficulty of integrating\n...into existing codebase",
        "Insufficient libraries/driver support": "Insufficient libraries\n.../driver support",
    },
    drop=[
        "Both are terrible languages with horrific syntax",
        "Yes, I have used it and scrapped it for these reasons. It was a mess.",
    ],
)
df_out[column] = values

plot_hist(values, rotated=True)
plt.show()
```

### How likely to adopt

```{python}
column = Column.S5_MODERN_ADOPTION
values = df[column]
df_out[column] = values

plot_hist(values, sort_by_index=True, range=range(1, 6))
plt.show()
```

## Section 6: Tooling and ecosystem

## Section 7: Open section
