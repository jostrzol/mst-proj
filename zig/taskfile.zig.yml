version: '3'
vars:
  PROFILES: &profiles [debug, fast, small]
  PROJECTS_OS: &projects_os [1-blinky, 2-motor, 3-pid]
  PROJECTS_BM: &projects_bm [1-blinky-bm, 2-motor-bm, 3-pid-bm]
  PROFILE_FLAG_MAP:
    map:
      debug: ""
      fast: --release=fast
      small: --release=small
  C_BUILD_TYPE_MAP:
    map:
      debug: Debug
      fast: Release
      small: MinSizeRel
  SDKCONFIG_MAP:
    map:
      debug: sdkconfig
      fast: sdkconfig.fast
      small: sdkconfig.small
  ESP_EXPORT: ". esp-export/zig.sh"
  ZIG_VERSION: "0.13.0"
  ZIG_TRIPLET_OS: "arm-linux-gnueabihf"
  ZIG_CPU_OS: "arm1176jzf_s"
tasks:
  # os and bm
  build-every-profile:
    deps: [build-os-every-profile, build-bm-every-profile]
  build-all:
    requires:
      vars:
        - {name: PROFILE, enum: *profiles}
    deps:
      - task: build-os-all
        vars: {PROFILE: '{{.PROFILE}}'}
      - task: build-bm-all
        vars: {PROFILE: '{{.PROFILE}}'}
  # os
  build-os-every-profile:
    cmds:
      - for: [fast, small]
        task: build-os-all
        vars:
          PROFILE: '{{.ITEM}}'
      - task: build-os
        vars:
          PROJECT: '3-pid'
          PROFILE: 'debug'
  build-os-all:
    requires:
      vars:
        - {name: PROFILE, enum: *profiles}
    deps:
      - for: {var: PROJECTS_OS}
        task: build-os
        vars:
          PROJECT: '{{.ITEM}}'
          PROFILE: '{{.PROFILE}}'
  build-os:
    requires:
      vars:
        - {name: PROJECT, enum: *projects_os}
        - {name: PROFILE, enum: *profiles}
    sources:
      - '{{joinPath "./zig" .PROJECT "**/*.zig"}}'
      - exclude: '{{joinPath "./zig" .PROJECT "zig-out/**/*.zig"}}'
      - exclude: '{{joinPath "./zig" .PROJECT ".zig-cache/**/*.zig"}}'
    generates: ['{{.ARTIFACTS_DIR}}/{{.PROFILE}}/{{.PROJECT}}-zig']
    vars:
      PROJECT_DIR: '{{joinPath "zig" .PROJECT}}'
      PROFILE_FLAG: '{{.PROFILE | get .PROFILE_FLAG_MAP}}'
      LOG_LEVEL_FLAG: '{{if .LOG_LEVEL}}-Dlog-level={{.LOG_LEVEL | lower}}{{end}}'
    cmds:
      - |
        cd {{.PROJECT_DIR}} && zvm run {{.ZIG_VERSION}} build \
          -Dtarget={{.ZIG_TRIPLET_OS}} \
          -Dcpu={{.ZIG_CPU_OS}} \
          {{.PROFILE_FLAG}} \
          {{.LOG_LEVEL_FLAG}} \
          -freference-trace
      - task: copy-artifact
        vars:
          FILE: '{{joinPath .PROJECT_DIR "zig-out" "bin" .PROJECT}}-zig'
          PROFILE: '{{.PROFILE}}'
          PROJECT: '{{.PROJECT}}'
    label: 'zig:build-os:{{.PROFILE}}:{{.PROJECT}}'
  # bm
  build-bm-every-profile:
    cmds:
      - for: {matrix: {PROFILE: [fast, small]}}
        task: build-bm-all
        vars:
          PROFILE: '{{.ITEM.PROFILE}}'
  build-bm-all:
    requires:
      vars:
        - {name: PROFILE, enum: *profiles}
    deps:
      - for: {var: PROJECTS_BM}
        task: build-bm
        vars:
          PROJECT: '{{.ITEM}}'
          PROFILE: '{{.PROFILE}}'
  build-bm:
    requires:
      vars:
        - {name: PROJECT, enum: *projects_bm}
        - {name: PROFILE, enum: *profiles}
    vars:
      NAME: '{{index (splitList "-" .PROJECT) 1}}'
    sources:
      - '{{joinPath "./zig" .PROJECT "**/*.zig"}}'
      - '{{joinPath "./zig" .PROJECT "*"}}'
      - exclude: '{{joinPath "./zig" .PROJECT "build/**/*"}}'
      - exclude: '{{joinPath "./zig" .PROJECT ".zig-cache/**/*"}}'
      - exclude: '{{joinPath "./zig" .PROJECT "zig-out/**/*"}}'
    generates:
      - '{{.ARTIFACTS_DIR}}/{{.PROFILE}}/{{.PROJECT}}-zig'
      - '{{.ARTIFACTS_DIR}}/{{.PROFILE}}/{{.PROJECT}}-zig.elf'
    cmds:
      - task: cmd-bm
        vars:
          PROJECT: '{{.PROJECT}}'
          PROFILE: '{{.PROFILE}}'
          CMD: 'build'
      - task: copy-artifact
        vars:
          FILE: '{{joinPath "./c" .PROJECT "build" (printf "%s.bin" .NAME)}}'
          PROJECT: '{{.PROJECT}}'
          PROFILE: '{{.PROFILE}}'
      - task: copy-artifact
        vars:
          FILE: '{{joinPath "./c" .PROJECT "build" (printf "%s.elf" .NAME)}}'
          PROJECT: '{{.PROJECT}}'
          PROFILE: '{{.PROFILE}}'
          SUFFIX: '.elf'
    label: 'zig:build-bm:{{.PROFILE}}:{{.PROJECT}}'
  flash-bm:
    requires:
      vars:
        - {name: PROJECT, enum: *projects_bm}
    cmds:
      - task: cmd-bm
        vars:
          PROJECT: '{{.PROJECT}}'
          CMD: 'flash monitor'
  cmd-bm:
    internal: true
    requires:
      vars:
        - {name: PROJECT, enum: *projects_bm}
    # optional: PROFILE
    vars:
      PROJECT_DIR: '{{joinPath "./c" .PROJECT}}'
      SDKCONFIG: '{{.PROFILE | get .SDKCONFIG_MAP | default "sdkconfig"}}'
    cmd: |
      sh -c '
        {{if not .IDF_PATH}}{{.ESP_EXPORT}}{{end}}
        cd {{.PROJECT_DIR}} && idf.py -DSDKCONFIG={{.SDKCONFIG}} {{.CMD}}
      '
  # utils
  copy-artifact:
    internal: true
    requires:
      vars:
        - FILE
        - PROJECT
        - {name: PROFILE, enum: *profiles}
    vars:
      SUFFIX: '{{.SUFFIX | default ""}}'
      OUTPUT_FILE: '{{.ARTIFACTS_DIR}}/{{.PROFILE}}/{{.PROJECT}}-zig{{.SUFFIX}}'
    sources: ['{{.FILE}}']
    generates: ['{{.OUTPUT_FILE}}']
    deps:
      - task: artifact-dir-exists
        vars: {PROFILE: '{{.PROFILE}}'}
    cmd: 'cp {{.FILE}} {{.OUTPUT_FILE}}'
    label: 'zig:copy-artifact:{{.PROFILE}}/{{.PROJECT}}-zig{{.SUFFIX}}'
  artifact-dir-exists:
    requires:
      vars:
        - {name: PROFILE, enum: *profiles}
    internal: true
    cmd: mkdir -p '{{.ARTIFACTS_DIR}}/{{.PROFILE}}'
